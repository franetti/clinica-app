<div class="welcome-bg"></div>

<div class="register-container">
  <h2>Registro de Usuario</h2>

  <!-- Selección de tipo de usuario -->
  <div class="seleccion-tipo" *ngIf="!mostrarFormulario" [@fadeIn]>
    <div class="botones-tipo-container">
      <button 
        mat-raised-button 
        class="boton-tipo-usuario"
        (click)="seleccionarTipoUsuario('paciente')"
        [@slideInUp]>
        <div class="imagen-container">
          <img [src]="imagenPaciente" alt="Paciente" />
        </div>
        <div class="boton-label">Paciente</div>
      </button>

      <button 
        mat-raised-button 
        class="boton-tipo-usuario"
        (click)="seleccionarTipoUsuario('especialista')"
        [@slideInUp]>
        <div class="imagen-container">
          <img [src]="imagenEspecialista" alt="Especialista" />
        </div>
        <div class="boton-label">Especialista</div>
      </button>

      <button 
        *ngIf="isAdmin"
        mat-raised-button 
        class="boton-tipo-usuario"
        (click)="seleccionarTipoUsuario('admin')"
        [@slideInUp]>
        <div class="imagen-container">
          <img [src]="imagenAdmin" alt="Administrador" />
        </div>
        <div class="boton-label">Administrador</div>
      </button>
    </div>
  </div>

  <!-- Formulario de registro -->
  <div class="formulario-container" *ngIf="mostrarFormulario" [@slideInDown]>
    <button mat-icon-button class="boton-volver" (click)="volverASeleccion()" matTooltip="Volver a selección">
      <mat-icon>arrow_back</mat-icon>
    </button>

    <form [formGroup]="usuarioForm" (ngSubmit)="onSubmit()" class="formulario">
      <h3>Registro de {{ tipoUsuario | titlecase }}</h3>

      <mat-form-field appearance="fill">
          <mat-label>Nombre</mat-label>
          <input matInput formControlName="nombre" />
          <mat-error *ngIf="usuarioForm.get('nombre')?.hasError('required')">
            El nombre es requerido
          </mat-error>
          <mat-error *ngIf="usuarioForm.get('nombre')?.hasError('pattern')">
            El nombre solo puede contener letras
          </mat-error>
      </mat-form-field>

      <mat-form-field appearance="fill">
          <mat-label>Apellido</mat-label>
          <input matInput formControlName="apellido" />
          <mat-error *ngIf="usuarioForm.get('apellido')?.hasError('required')">
            El apellido es requerido
          </mat-error>
          <mat-error *ngIf="usuarioForm.get('apellido')?.hasError('pattern')">
            El apellido solo puede contener letras
          </mat-error>
      </mat-form-field>

      <mat-form-field appearance="fill">
          <mat-label>Edad</mat-label>
          <input matInput type="number" formControlName="edad" />
      </mat-form-field>

      <mat-form-field appearance="fill">
          <mat-label>DNI</mat-label>
          <input matInput formControlName="dni" />
      </mat-form-field>
      
      <div *ngIf="tipoUsuario == 'especialista'" class="especialidades-container">
          <mat-form-field appearance="fill">
              <mat-label>Seleccionar Especialidad</mat-label>            
              <mat-select #especialidadSelect (selectionChange)="agregarEspecialidadDesdeSelect($event.value)">
                  <mat-option value="">-- Seleccione una especialidad --</mat-option>
                  <mat-option *ngFor="let especialidad of especialidades" [value]="especialidad">
                    {{especialidad}}
                  </mat-option>
              </mat-select>
          </mat-form-field>

          <div class="nueva-especialidad-container">
              <mat-form-field appearance="fill" style="flex: 1;">
                  <mat-label>Agregar Nueva Especialidad</mat-label>
                  <input matInput [(ngModel)]="nuevaEspecialidad" formControlName="nuevaEspecialidad" 
                         (keyup.enter)="agregarEspecialidadDesdeInput()" />
              </mat-form-field>
              <button mat-raised-button color="primary" 
                      (click)="agregarEspecialidadDesdeInput()" 
                      type="button" 
                      aria-label="Agregar especialidad"
                      [disabled]="!nuevaEspecialidad || nuevaEspecialidad.trim().length === 0">
                  <mat-icon>add</mat-icon>
                  <span>Agregar</span>
              </button>
          </div>

          <!-- Mostrar especialidades seleccionadas -->
          <div *ngIf="especialidadesSeleccionadas.length > 0" class="especialidades-seleccionadas">
              <label>Especialidades seleccionadas:</label>
              <mat-chip-set>
                  <mat-chip *ngFor="let especialidad of especialidadesSeleccionadas" 
                            (removed)="eliminarEspecialidad(especialidad)">
                      {{especialidad}}
                      <button matChipRemove>
                          <mat-icon>cancel</mat-icon>
                      </button>
                  </mat-chip>
              </mat-chip-set>
          </div>
      </div>
      
      <div *ngIf="tipoUsuario == 'paciente'">
          <mat-form-field appearance="fill">
              <mat-label>Obra Social</mat-label>            
              <input matInput formControlName="obraSocial" />
          </mat-form-field>
      </div>

      <mat-form-field appearance="fill">
          <mat-label>Email</mat-label>
          <input matInput formControlName="email" type="email" />
          <mat-error *ngIf="usuarioForm.get('email')?.hasError('required')">
            El email es requerido
          </mat-error>
          <mat-error *ngIf="usuarioForm.get('email')?.hasError('email')">
            Ingrese un email válido
          </mat-error>
          <mat-error *ngIf="usuarioForm.get('email')?.hasError('emailExiste')">
            Este email ya está registrado
          </mat-error>
          <mat-error *ngIf="usuarioForm.get('email')?.pending">
            Verificando email...
          </mat-error>
      </mat-form-field>

      <mat-form-field appearance="fill">
          <mat-label>Contraseña</mat-label>
          <input matInput type="password" formControlName="password" />
      </mat-form-field>

      <label>Imagen perfil:</label>
      <input type="file" (change)="onFileSelected($event, 'imagen', usuarioForm)" />

      <div *ngIf="tipoUsuario == 'paciente'" style="display: flex;flex-direction: column;gap:1rem">
          <label>Imagen perfil 2:</label>
          <input type="file" (change)="onFileSelected($event, 'imagen2', usuarioForm)" />
      </div>

      <!-- reCAPTCHA -->
      <div class="recaptcha-container">
          <re-captcha 
              [siteKey]="siteKey"
              (resolved)="onCaptchaResolved($event)"
              size="normal">
          </re-captcha>
          <p class="recaptcha-info">
              <mat-icon>info</mat-icon>
              Por favor, complete el captcha para continuar
          </p>
      </div>

      <button mat-raised-button color="primary" type="submit">Registrar</button>
    </form>
  </div>
</div>
