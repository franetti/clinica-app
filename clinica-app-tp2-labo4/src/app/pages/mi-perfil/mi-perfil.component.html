<div class="perfil-container">
  <div class="perfil-content">
    <mat-card class="perfil-card">
      <mat-card-header>
        <mat-card-title>
          Mi Perfil
        </mat-card-title>
      </mat-card-header>
      
      <mat-card-content *ngIf="usuario">
        <div class="perfil-info">
          <div class="imagenes-container">
            <div class="imagen-principal" *ngIf="usuario.imagen">
              <img [src]="usuario.imagen" alt="Foto de perfil" appHoverZoom />
            </div>
          </div>

          <div class="datos-personales">
            <div class="dato-item">
              <div class="dato-content">
                <span class="dato-label">Nombre completo</span>
                <span class="dato-value">{{ usuario.nombre }} {{ usuario.apellido }}</span>
              </div>
            </div>

            <div class="dato-item">
              <div class="dato-content">
                <span class="dato-label">Email</span>
                <span class="dato-value">{{ usuario.email }}</span>
              </div>
            </div>

            <div class="dato-item">
              <div class="dato-content">
                <span class="dato-label">DNI</span>
                <span class="dato-value">{{ usuario.dni | dniFormato:'conPuntos' }}</span>
              </div>
            </div>

            <div class="dato-item">
              <div class="dato-content">
                <span class="dato-label">Edad</span>
                <span class="dato-value">{{ usuario.edad }} años</span>
              </div>
            </div>

            <div class="dato-item">
              <div class="dato-content">
                <span class="dato-label">Tipo de usuario</span>
                <span class="dato-value tipo-usuario">{{ usuario.tipoUsuario }}</span>
              </div>
            </div>

            <div class="dato-item" *ngIf="usuario.obraSocial">
              <div class="dato-content">
                <span class="dato-label">Obra Social</span>
                <span class="dato-value">{{ usuario.obraSocial }}</span>
              </div>
            </div>

            <div class="dato-item" *ngIf="usuario.especialidad">
              <div class="dato-content">
                <span class="dato-label">Especialidad(es)</span>
                <div class="especialidades-chips">
                  <mat-chip-set>
                    <mat-chip *ngFor="let esp of especialidades">{{ esp }}</mat-chip>
                  </mat-chip-set>
                </div>
              </div>
            </div>

            <div class="dato-item" *ngIf="usuario.tipoUsuario === 'especialista'">
              <div class="dato-content">
                <span class="dato-label">Estado</span>
                <span class="dato-value" 
                      [appHighlight]="usuario.habilitado" 
                      [highlightCondition]="'enabled'">
                  {{ usuario.habilitado ? 'Habilitado' : 'No habilitado' }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="horarios-card" *ngIf="esEspecialista()">
      <mat-card-header>
        <mat-card-title>
          Mis Horarios
        </mat-card-title>
        <mat-card-subtitle>
          Gestiona tu disponibilidad horaria
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <div class="crear-horarios-section">
          <h3>Configurar días y horarios de trabajo</h3>

          <div class="info-hint">
            <p>
              Configure los días de la semana y el horario de atención para cada especialidad. 
              Los turnos se generarán automáticamente cada 30 minutos dentro del rango horario seleccionado.
            </p>
          </div>
          
          <div class="form-row">
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Especialidad</mat-label>
              <mat-select [(ngModel)]="especialidadSeleccionada" (selectionChange)="onEspecialidadChange()">
                <mat-option *ngFor="let esp of especialidades" [value]="esp">
                  {{ esp }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div class="dias-selection" *ngIf="especialidadSeleccionada">
            <div class="dias-header">
              <h4>Seleccione los días de trabajo:</h4>
              <button 
                mat-stroked-button 
                color="primary"
                (click)="seleccionarTodosLosDias()"
                class="btn-seleccionar-todos">
                {{ todosDiasMarcados() ? 'Deseleccionar' : 'Seleccionar' }} todos
              </button>
            </div>
            
            <div class="dias-grid">
              <button 
                *ngFor="let dia of diasSemana"
                mat-raised-button
                [color]="isDiaSeleccionado(dia.numero) ? 'primary' : ''"
                (click)="toggleDia(dia.numero)"
                class="dia-btn"
                [class.seleccionado]="isDiaSeleccionado(dia.numero)">
                <span class="dia-nombre">{{ dia.nombre }}</span>
              </button>
            </div>

            <div class="horario-selector">
              <h4>Configure el horario de atención:</h4>
              
              <div class="horario-row">
                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>Hora de inicio</mat-label>
                  <mat-select [(ngModel)]="horaInicio">
                    <mat-option *ngFor="let hora of horasDisponibles" [value]="hora.valor">
                      {{ hora.texto }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline" class="form-field">
                  <mat-label>Hora de fin</mat-label>
                  <mat-select [(ngModel)]="horaFin">
                    <mat-option *ngFor="let hora of getHorasFinDisponibles()" [value]="hora.valor">
                      {{ hora.texto }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <div class="horario-info-card">
                <div>
                  <p><strong>Turnos cada 30 minutos</strong></p>                  
                </div>
              </div>
            </div>

            <ng-template appCustomCaptcha 
                         (captchaResolved)="onCaptchaResolved($event)">
            </ng-template>

            <div class="acciones-horarios">
              <p *ngIf="diasSeleccionados.length > 0" class="seleccionados-count">
                {{ diasSeleccionados.length }} día(s) seleccionado(s)
              </p>
              <button 
                mat-raised-button 
                color="primary" 
                (click)="guardarHorarios()"
                [disabled]="diasSeleccionados.length === 0 || cargando">
                Guardar configuración
              </button>
            </div>
          </div>
        </div>

        <mat-divider></mat-divider>

        <div class="horarios-existentes-section">
          <h3>
            Configuraciones de horarios
          </h3>

          <div *ngIf="cargando" class="loading-container">
            <mat-spinner diameter="50"></mat-spinner>
            <p>Cargando horarios...</p>
          </div>

          <div *ngIf="!cargando && horariosExistentes.length === 0" class="no-horarios">
            <p>No hay horarios configurados aún</p>
            <p class="subtitle">Configure sus días de trabajo usando el formulario superior</p>
          </div>

          <div *ngIf="!cargando && horariosExistentes.length > 0" class="horarios-list">
            <mat-card *ngFor="let horario of horariosExistentes" class="horario-item">
              <mat-card-content>
                <div class="horario-info">
                  <div class="horario-especialidad">
                    <span class="especialidad-nombre">{{ horario.especialidad }}</span>
                  </div>
                  
                  <div class="horario-dias">
                    <span>{{ obtenerDiasFormateados(horario.dias) }}</span>
                  </div>

                  <div class="horario-horas">
                    <span>{{ obtenerHorarioFormateado(horario.horario) }}</span>
                  </div>
                </div>

                <div class="horario-acciones">
                  <button 
                    mat-icon-button 
                    color="warn" 
                    (click)="eliminarHorario(horario)"
                    [disabled]="cargando"
                    matTooltip="Eliminar configuración">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="historia-clinica-card" *ngIf="esPaciente()">
      <mat-card-header>
        <mat-card-title>
          Mi Historia Clínica
        </mat-card-title>
        <mat-card-subtitle>
          Registro completo de atenciones y controles
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <div class="historia-clinica-controls" *ngIf="!cargando && historiaClinica.length > 0">
          <mat-form-field appearance="outline" style="flex: 1; margin-right: 10px;">
            <mat-label>Filtrar por Especialidad</mat-label>
            <mat-select [(ngModel)]="especialidadSeleccionadaPDF" (selectionChange)="onEspecialidadPDFChange()">
              <mat-option value="todas">Todas las especialidades</mat-option>
              <mat-option *ngFor="let esp of especialidadesDisponibles" [value]="esp">
                {{ esp }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <button 
            mat-raised-button 
            color="primary" 
            (click)="descargarPDFHistoriaClinica()"
            [disabled]="descargandoPDF || historiaClinica.length === 0">
            <mat-spinner *ngIf="descargandoPDF" diameter="20" style="display: inline-block; margin-right: 8px;"></mat-spinner>
            <span *ngIf="!descargandoPDF">Descargar PDF Historia</span>
            <span *ngIf="descargandoPDF">Generando...</span>
          </button>
          <button 
            mat-raised-button 
            color="accent" 
            (click)="descargarPDFTurnos()"
            [disabled]="descargandoPDFTurnos || especialidadSeleccionadaPDF === 'todas' || turnosFiltradosPorEspecialidad().length === 0">
            <mat-spinner *ngIf="descargandoPDFTurnos" diameter="20" style="display: inline-block; margin-right: 8px;"></mat-spinner>
            <span *ngIf="!descargandoPDFTurnos">Descargar PDF Turnos</span>
            <span *ngIf="descargandoPDFTurnos">Generando...</span>
          </button>
        </div>
        <div *ngIf="cargando" class="loading-container">
          <mat-spinner diameter="50"></mat-spinner>
          <p>Cargando historia clínica...</p>
        </div>

        <div *ngIf="!cargando && historiaClinica.length === 0" class="no-historia">
          <p>No hay registros de historia clínica aún</p>
          <p class="subtitle">Los registros aparecerán aquí después de cada atención médica</p>
        </div>

        <div *ngIf="!cargando && historiaClinica.length > 0 && historiaClinicaFiltrada.length === 0" class="no-historia">
          <p>No hay registros de historia clínica para la especialidad seleccionada</p>
        </div>

        <div *ngIf="!cargando && historiaClinicaFiltrada.length > 0" class="historia-list">
          <mat-card *ngFor="let registro of historiaClinicaFiltrada" class="historia-item">
            <mat-card-content>
              <div class="historia-header">
                <div class="historia-fecha">
                  <span>{{ formatearFechaHistoria(registro.created_at) }}</span>
                </div>
              </div>

              <div class="historia-datos">
                <h4>Datos Fijos</h4>
                <div class="datos-grid">
                  <div class="dato-item" *ngIf="registro.altura">
                    <div>
                      <span class="dato-label">Altura</span>
                      <span class="dato-value">{{ registro.altura | historiaClinicaFormato:'altura' }}</span>
                    </div>
                  </div>
                  <div class="dato-item" *ngIf="registro.peso">
                    <div>
                      <span class="dato-label">Peso</span>
                      <span class="dato-value">{{ registro.peso | historiaClinicaFormato:'peso' }}</span>
                    </div>
                  </div>
                  <div class="dato-item" *ngIf="registro.temperatura">
                    <div>
                      <span class="dato-label">Temperatura</span>
                      <span class="dato-value">{{ registro.temperatura | historiaClinicaFormato:'temperatura' }}</span>
                    </div>
                  </div>
                  <div class="dato-item" *ngIf="registro.presion">
                    <div>
                      <span class="dato-label">Presión</span>
                      <span class="dato-value">{{ registro.presion | historiaClinicaFormato:'presion' }}</span>
                    </div>
                  </div>
                </div>

                <div *ngIf="parsearDatosDinamicos(registro.dinamicos).length > 0" class="datos-dinamicos-section">
                  <h4>Otros Datos</h4>
                  <div class="dinamicos-list">
                    <div *ngFor="let dato of parsearDatosDinamicos(registro.dinamicos)" class="dato-dinamico">
                      <span class="dato-clave">{{ dato.clave }}:</span>
                      <span class="dato-valor">{{ dato.valor }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>

